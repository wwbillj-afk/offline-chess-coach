<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Offline Chess Coach — Play</title>

<!-- Link to manifest (required for Android install prompt) -->
<link rel="manifest" href="/manifest.json">

<style>
:root{
  --bg-top:#081826; --bg-bottom:#031020;
  --glass-1: rgba(255,255,255,0.04);
  --glass-2: rgba(255,255,255,0.01);
  --sq-light:#e7f6fc;
  --sq-dark:#2f4655;
  --accent:#6fc23b;
  --muted:#b7d1e2;
}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg-top),var(--bg-bottom));font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;color:#eaf6ff}
header{padding:16px;text-align:center;font-weight:800;font-size:20px}
.app{display:flex;height:calc(100vh - 56px);gap:12px;padding:10px;box-sizing:border-box}
.left{flex:1;display:flex;flex-direction:column;align-items:center}
.board-frame{
  width:94vw; max-width:520px; padding:14px;
  border-radius:18px;
  background:linear-gradient(180deg,var(--glass-1),var(--glass-2));
  box-shadow:0 22px 60px rgba(0,0,0,0.65);
  display:flex;align-items:center;justify-content:center;
}
.board{
  width:92vw; max-width:480px; aspect-ratio:1/1;
  display:grid; grid-template-columns:repeat(8,1fr);
  border-radius:12px; overflow:hidden; position:relative;
  border:5px solid rgba(0,0,0,0.08);
}

/* squares */
.square{display:flex;align-items:center;justify-content:center;user-select:none;touch-action:manipulation;position:relative}
.light{background:linear-gradient(180deg,var(--sq-light),#cfeaf7)}
.dark{background:linear-gradient(180deg,var(--sq-dark),#2b4958)}
/* piece visuals (Unicode fallback but heavily styled) */
.piece{
  font-size: calc(20px + 2.6vw); line-height:0.95;
  -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  text-shadow: 0 6px 12px rgba(0,0,0,0.55), 0 1px 0 rgba(255,255,255,0.04);
  transition: transform 160ms ease;
  transform-origin:center;
}
.white-piece{color:#ffffff;}
.black-piece{color:#071218;text-shadow:0 6px 12px rgba(0,0,0,0.55), 0 1px 0 rgba(255,255,255,0.03);}

/* highlights */
.selected{outline:5px solid rgba(111,194,59,0.36);box-shadow:0 12px 28px rgba(0,0,0,0.45)}
.last-from::after, .last-to::after{
  content:''; position:absolute; inset:0; border-radius:inherit;
  background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(111,194,59,0.05));
  mix-blend-mode: overlay;
}

/* moving pulse */
.pulse{animation:pulseMove 520ms ease}
@keyframes pulseMove {0%{transform:scale(.9);opacity:.6}60%{transform:scale(1.06);opacity:1}100%{transform:scale(1);opacity:1}}

/* controls */
.controls{display:flex;gap:12px;align-items:center;margin-top:14px;width:100%;max-width:760px}
.btn{padding:10px 14px;border-radius:12px;border:none;background:#1f2937;color:#eaf6ff;cursor:pointer;box-shadow:0 8px 18px rgba(0,0,0,0.5)}
.btn.primary{background:var(--accent);color:#04210b;font-weight:800}
.statusSmall{font-weight:700;color:var(--muted)}

/* coach panel */
.coach{width:360px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-left:1px solid rgba(255,255,255,0.03);display:flex;flex-direction:column;padding:12px;border-radius:10px}
.coachHeader{display:flex;gap:12px;align-items:center;padding-bottom:8px;border-bottom:1px solid rgba(255,255,255,0.03)}
.avatar{width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,#f472b6,#fb7185);display:flex;align-items:center;justify-content:center;color:#07102a;font-weight:700}
.coachBody{flex:1;overflow:auto;padding-top:8px}
.coachLine{margin-bottom:12px;font-size:15px;background:linear-gradient(180deg,rgba(255,255,255,0.01),transparent);padding:8px;border-radius:8px}
.coachFooter{display:flex;gap:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.03)}

/* responsive */
@media(max-width:900px){.coach{display:none}}
</style>
</head>
<body>

<header>Play vs Coach</header>

<div class="app">
  <div class="left">
    <div class="board-frame">
      <div id="board" class="board" aria-label="Chessboard"></div>
    </div>

    <div class="controls">
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn primary" id="flipBtn">Flip Board</button>

      <label style="margin-left:8px;color:var(--muted);font-weight:600">Difficulty</label>
      <input id="diffRange" type="range" min="0" max="100" value="30" style="width:120px">

      <div style="flex:1"></div>
      <div id="statusSmall" class="statusSmall">Coach: Ready</div>
    </div>
  </div>

  <div class="coach" id="coachPanel">
    <div class="coachHeader">
      <div class="avatar">♛</div>
      <div>
        <div style="font-weight:800" id="coachName">Coach</div>
        <div style="font-size:13px;color:#a9c3d6">Friendly teacher (offline)</div>
      </div>
    </div>

    <div id="coachBody" class="coachBody"></div>

    <div class="coachFooter">
      <button class="btn" id="whyBtn">Why?</button>
      <button class="btn" id="toggleCoachBtn">Collapse</button>
    </div>
  </div>
</div>

<script>
/* -------------------------
  Final polished play.html
  - Offline-ready (service worker registration if available)
  - Robust Unicode piece rendering with depth styling
  - Coach, difficulty slider stub, flip/reset, last-move highlight
  - One-file: play.html (plus optional /offline-sw.js + /manifest.json)
-------------------------*/

/* Unicode pieces */
const PIECES = {
  r:'♜', n:'♞', b:'♝', q:'♛', k:'♚', p:'♟',
  R:'♖', N:'♘', B:'♗', Q:'♕', K:'♔', P:'♙'
};

/* starting pos (0=a8..63=h1) */
let pos = [
  'r','n','b','q','k','b','n','r',
  'p','p','p','p','p','p','p','p',
  '','','','','','','','',
  '','','','','','','','',
  '','','','','','','','',
  '','','','','','','','',
  'P','P','P','P','P','P','P','P',
  'R','N','B','Q','K','B','N','R'
];

let flipped = false;
let selected = null;
let lastMove = {from:null, to:null};

const boardEl = document.getElementById('board');
const coachBody = document.getElementById('coachBody');
const statusSmall = document.getElementById('statusSmall');
const diffRange = document.getElementById('diffRange');

function coachSay(text){
  const d = document.createElement('div');
  d.className = 'coachLine';
  d.innerHTML = `<strong>Coach:</strong> ${text}`;
  coachBody.appendChild(d);
  coachBody.scrollTop = coachBody.scrollHeight;
  statusSmall.textContent = 'Coach: ' + text;
}

/* draw board function with highlights */
function drawBoard(){
  boardEl.innerHTML = '';
  const indices = [...Array(64).keys()];
  if(flipped) indices.reverse();
  for(const idx of indices){
    const r = Math.floor(idx/8), c = idx%8;
    const div = document.createElement('div');
    div.className = 'square ' + (((r+c)%2) ? 'dark' : 'light');
    div.dataset.idx = idx;

    // last-move highlight
    if(lastMove.from === idx) div.classList.add('last-from');
    if(lastMove.to === idx) div.classList.add('last-to');

    const piece = pos[idx];
    if(piece){
      const span = document.createElement('div');
      span.className = 'piece ' + (piece === piece.toUpperCase() ? 'white-piece' : 'black-piece');
      span.textContent = PIECES[piece] || '?';
      // slight pop animation
      span.style.transform = 'scale(.98)';
      setTimeout(()=>span.style.transform='scale(1)', 30);
      div.appendChild(span);
    }

    if(selected === idx) div.classList.add('selected');
    div.addEventListener('click', ()=>onSquareClick(Number(div.dataset.idx)));
    boardEl.appendChild(div);
  }
}

/* click handling */
function onSquareClick(idx){
  if(selected === null){
    if(!pos[idx]){ coachSay('Tap a piece first.'); return; }
    selected = idx; drawBoard(); coachSay('Selected ' + idxToAlg(idx)); return;
  }
  if(selected === idx){ selected=null; drawBoard(); coachSay('Selection cleared.'); return; }
  lastMove.from = selected; lastMove.to = idx;
  pos[idx] = pos[selected]; pos[selected] = '';
  selected = null;
  drawBoard();
  animateTarget(lastMove.to);
  coachSay(`${playerName} moved ${idxToAlg(lastMove.from)} → ${idxToAlg(lastMove.to)}.`);
}

function idxToAlg(i){ return String.fromCharCode(97 + (i%8)) + (8 - Math.floor(i/8)); }

/* animate target */
function animateTarget(idx){
  const el = [...boardEl.children].find(ch => Number(ch.dataset.idx) === idx);
  if(!el) return;
  el.classList.add('pulse');
  setTimeout(()=>el.classList.remove('pulse'), 520);
}

/* controls */
document.getElementById('flipBtn').addEventListener('click', ()=>{ flipped=!flipped; drawBoard(); });
document.getElementById('resetBtn').addEventListener('click', ()=>{
  pos = [
    'r','n','b','q','k','b','n','r',
    'p','p','p','p','p','p','p','p',
    '','','','','','','','',
    '','','','','','','','',
    '','','','','','','','',
    '','','','','','','','',
    'P','P','P','P','P','P','P','P',
    'R','N','B','Q','K','B','N','R'
  ]; selected=null; lastMove={from:null,to:null}; coachBody.innerHTML=''; coachSay('Board reset.'); drawBoard();
});

document.getElementById('whyBtn').addEventListener('click', ()=>coachSay('Because strong plans grow from principles — ask what each piece is doing.'));
document.getElementById('toggleCoachBtn').addEventListener('click', ()=>{
  const panel = document.getElementById('coachPanel');
  panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
  localStorage.setItem('coachCollapsed', panel.style.display === 'none' ? '1' : '0');
});

/* difficulty change (no engine yet) */
diffRange.addEventListener('input', ()=>{ coachSay('Difficulty set to ' + diffRange.value + '.'); });

/* remember name */
let playerName = localStorage.getItem('playerName') || null;
if(!playerName){
  playerName = prompt('What should I call you?') || 'Friend';
  localStorage.setItem('playerName', playerName);
}
coachSay(`Hello ${playerName}. We learn from books and practice deliberately.`);

/* restore coach collapsed */
const saved = localStorage.getItem('coachCollapsed');
if(saved === '1') document.getElementById('coachPanel').style.display = 'none';

/* initial draw */
drawBoard();

/* ---------- Service worker registration (optional) ---------- */
/* If /offline-sw.js exists it will be registered and will cache app files to enable install & offline */
if ('serviceWorker' in navigator){
  navigator.serviceWorker.register('/offline-sw.js').then(reg=>{
    console.log('SW registered:', reg.scope);
  }).catch(err=>{
    console.log('SW registration failed:', err);
  });
}
</script>
</body>
  </html>
